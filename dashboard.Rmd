---
title: "Restaurant Inspections in Queens (2015-2024)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: flatly
---

```{r include = FALSE,message=FALSE,warning=FALSE}
library(flexdashboard)
library(tidyverse)
library(httr)
library(jsonlite)
library(plotly)
library(ggpubr)
library(stringr)


knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

column {data-width=500}
-----------------------------------------------------------------------

```{r, message = FALSE, echo = FALSE, include=FALSE}
get_all_inspections = function(url) {
  
  all_inspections = vector("list", length = 0)
  
  loop_index = 1
  chunk_size = 50000
  DO_NEXT = TRUE
  
  while (DO_NEXT) {
    message("Getting data, page ", loop_index)
    
    all_inspections[[loop_index]] = 
      GET(url,
          query = list(`$order` = "zipcode",
                       `$limit` = chunk_size,
                       `$offset` = as.integer((loop_index - 1) * chunk_size)
                       )
          ) %>%
      content("text") %>%
      fromJSON() %>%
      as_tibble()
    
    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size
    loop_index = loop_index + 1
  }
  
  all_inspections
  
}
url = "https://data.cityofnewyork.us/resource/43nn-pn8j.json"

nyc_inspections <-  get_all_inspections(url) %>%
  bind_rows() 
```

```{r, message = FALSE, echo = FALSE, include=FALSE}
nyc_inspections_df <- nyc_inspections |> 
  mutate(boro = case_when(boro == 0 ~ NA, 
                          TRUE ~ boro), 
         critical_flag = case_when(critical_flag == "Not Applicable" ~ "No Violation", 
                          TRUE ~ critical_flag), 
         inspection_date = case_when(inspection_date == "1900-01-01T00:00:00.000" ~ NA, 
                          TRUE ~ inspection_date),
         latitude = case_when(latitude == "0" ~ NA, 
                              TRUE ~ as.numeric(latitude)), 
         longitude =  case_when(longitude == "0" ~ NA, 
                              TRUE ~ as.numeric(longitude)), 
         score = as.numeric(score), 
         inspection_date = as.Date(inspection_date), 
         year = as.factor(year(inspection_date))) |> 
  filter(boro == "Queens") |> 
  drop_na(inspection_date)

```

### Chart A: number of inspection per restaurant

```{r, echo = FALSE, warnin = FALSE, message = FALSE}
number_of_inspection <- 
  nyc_inspections_df |> 
  count(camis, year) |> 
  ggplot(aes(x = year, y = n)) +
  geom_boxplot() +
  labs(y = "Number of Inspections per Restuarant", 
       x = "Year")

ggplotly(number_of_inspection)
```

> The average number of inspection for each restaurant remained below five at each year. However, during the recent years, there were some restaurants who received large number of inspections during the year. 

### Chart C: Have the scores improved in 2023 in Queens?
```{r, echo = FALSE}
nyc_inspections_df  |> 
  filter(year(inspection_date) == 2023) |> 
  ggplot(aes(x = inspection_date, y = score, group = camis)) +
  geom_point(alpha = 0.5) + 
  labs(x = "Date of Inspection",
       y = "Score")
```

Column {data-width=500}
-----------------------------------------------------------------------

### Chart B: Is the inspection score related to number of inspection that year?

```{r, echo = FALSE, warning = FALSE}
scatter_plot <- nyc_inspections_df |> 
  group_by(critical_flag, year, camis, dba) |> 
  summarize(average_score = mean(score, na.rm = TRUE), 
            average_number_of_inspections = n()) |> 
  mutate(name = str_to_title(dba)) |> 
  ungroup() |> 
  ggplot(aes(x = average_number_of_inspections, y = average_score, label = name)) +
  geom_point(aes(color = critical_flag), size = 0.5, alpha = 0.6) +
  geom_smooth(method = lm, se = FALSE) +
  ggpubr::stat_cor(method = "pearson", label.x = 5, label.y = 125, output.type= "text") +
  labs(y = "Average Score (in a Year/restaurant)", 
       x = "Average Number of Inspection (in a Year/restaurant)", 
       color = "Violation Types")

ggplotly(scatter_plot)
```

> Restaurants that were found to violate more/critical City and State food safety requirements also received more inspections during the year. Many of the inspections could \be follow-ups. Similarly, it could also be that restuarants who are inspected more are likely to have more violations recorded. 



